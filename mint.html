<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mint Token | Nextolito</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <img src="Logo.png" alt="Nextolito Logo" style="width:100px;margin-bottom:1rem;" />
    <h1>Mint Your Token</h1>
    <p>Create your custom token in seconds.</p>
    <a href="index.html" class="cta-button">← Back Home</a>
  </header>

  <section>
    <input type="text" id="tokenName" placeholder="Token Name" />
    <input type="text" id="tokenSymbol" placeholder="Symbol" />
    <input type="number" id="tokenSupply" placeholder="Total Supply" />
    <br />
    <button class="mint-button" id="mintButton">Mint Token</button>
    <p id="mint-status"></p>
  </section>

  <footer>
    &copy; 2025 Nextolito | All rights reserved
  </footer>

  <script type="module">
    import { supabase } from './supabase.js';

    async function getUserId() {
      const { data, error } = await supabase.auth.getUser();
      if (error || !data?.user) {
        alert("You must be logged in to mint tokens!");
        throw new Error("User not authenticated");
      }
      return data.user.id;
    }

    async function connectWallet() {
      if (!window.ethereum) {
        alert('Please install MetaMask or another Ethereum wallet.');
        throw new Error('No wallet detected');
      }
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      return accounts[0];
    }

    async function storeMintActivity(name, symbol, supply, wallet) {
      try {
        const user_id = await getUserId();

        const { error } = await supabase
          .from('mint_logs')
          .insert([{ name, symbol, supply, wallet, user_id }]);

        if (error) {
          console.error('Supabase Insert Error:', error.message);
          document.getElementById('mint-status').innerText = 'Mint failed: Could not log to database.';
        } else {
          document.getElementById('mint-status').innerText = `Minted ${supply} ${symbol} (${name}) successfully!`;
        }
      } catch (e) {
        console.error(e);
        document.getElementById('mint-status').innerText = 'Mint failed: ' + e.message;
      }
    }

    document.getElementById('mintButton').addEventListener('click', async () => {
      const name = document.getElementById('tokenName').value.trim();
      const symbol = document.getElementById('tokenSymbol').value.trim();
      const supply = document.getElementById('tokenSupply').value.trim();

      if (!name || !symbol || !supply) {
        document.getElementById('mint-status').innerText = 'Fill all fields.';
        return;
      }

      try {
        const wallet = await connectWallet();
        await storeMintActivity(name, symbol, parseInt(supply), wallet);
      } catch (error) {
        document.getElementById('mint-status').innerText = error.message;
      }
    });
  </script>
</body>
</html>
